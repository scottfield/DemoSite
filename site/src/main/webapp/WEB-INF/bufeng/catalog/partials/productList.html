<div id="product_list_panel" th:attr="showadd=${showAdd},host=${host},categoryid=${category.id}" class="five-card hidden" th:fragment="productList"
     th:if="${products}">
    <div class="product-list hidden"></div>
    <!--<div th:each="product,state:${products}" th:object="${product}" th:remove="tag">-->
    <!--<div class="card-box">-->
    <!--<span class="unlock" th:remove="all">解锁预购</span>-->
    <!--<a th:href="@{*{url}}">-->
    <!--<div class="img" style="background-image:url(../images/jjj_03.jpg);"-->
    <!--th:style="'background-image:url('+@{*{media['primary']['url']}}+')'"-->
    <!--th:if="${#maps.containsKey(product.media,'primary')}"></div>-->


    <!--&lt;!&ndash;如果是已抢光商品 就加这个标签&ndash;&gt;-->
    <!--<span class="sold-out"></span>-->
    <!--</a>-->
    <!--<div class="t hidden" th:text="*{name}">香奈儿清香黛尔香氛50ml</div>-->
    <!--<div class="pice hidden" th:inline="text">-->
    <!--<span>￥[[*{defaultSku.salePrice}]]</span>-->
    <!--<font>￥[[*{defaultSku.retailPrice}]]</font>-->
    <!--</div>-->
    <!--<div class="hidden btn">-->
    <!--<a href="#" class="addToCartBtn">-->
    <!--<img th:src="@{/images/in_48.png}" height="25" th:unless="*{defaultSku.quantityAvailable}" th:attr="data-productid=*{id},data-quantityAvailable=*{defaultSku.quantityAvailable}" />-->
    <!--<img th:src="@{/images/in_48_h.png}" height="25" th:if="*{defaultSku.quantityAvailable}" th:attr="data-productid=*{id},data-quantityAvailable=*{defaultSku.quantityAvailable}"/>-->
    <!--</a>-->
    <!--</div>-->
    <!--</div>-->
    <!--&lt;!&ndash;show this add when products count equal 4&ndash;&gt;-->
    <!--<div class="card-5" th:if="${state.count==2 and showAdd==true}"><img th:src="@{/images/new/index/index2.jpg}" width="100%"/></div>-->
    <!--</div>-->
    <!--&lt;!&ndash;show this ad when products count less than three&ndash;&gt;-->
    <!--<div class="card-5" th:if="${#lists.size(products) lt 3 and showAdd==true}"><img th:src="@{/images/udj_03.jpg}" width="100%"/></div>-->
    <div class="load-more">正在加载商品列表...</div>
    <script th:inline="text" th:attr="data-host=${host},data-category-id=${category.id}">
        //<![CDATA[
        $(document).ready(function () {
            var product_list_panel = $("#product_list_panel");
            var showAdd = product_list_panel.attr("showadd");
            var host = product_list_panel.attr("host");
            var categoryId = product_list_panel.attr("categoryid");

            $(window).scroll(function () {
                var w_height = $(this).height();
                if ($(this).scrollTop() + w_height >= product_list_panel.offset().top + product_list_panel.outerHeight()) {
                    loadProductList(pageLimit, currentOffset);
                }
            });
            var currentOffset = 1, loading = false, loadAll = false, pageLimit = 8, unlock = $("footer").data("unlock");

            function loadProductList(limit, offset) {
                if (loading || loadAll)return;
                loading = true;
                $.ajax({
                    url: host + '/api/v1/catalog/category/' + categoryId,
                    data: {
                        productLimit: limit,
                        productOffset: offset
                    },
                    success: function (response) {
                        var listHtml = [];
                        //hack
                        if (response.products === undefined) {
                            return;
                        }
                        if (response.products.product.constructor == Object) {
                            var product = [];
                            product.push(response.products.product);
                            response.products.product = product;
                        }
                        $.each(response.products.product, function (index) {
                            //判断是否需要显示解锁标志
                            var locker = unlock ? '' : '<span class="unlock">解锁预购</span>';
                            listHtml.push([
                                '<div class="card-box">',
                                locker,
                                '<a href="' + this.url + '">',
                                '<div class="img" style="background-image:url(', this.primaryMedia.url, ');"></div>',
                                this.quantityAvailable == 0 ? '<span class="sold-out"></span>' : '',
                                '</a>',
                                '<div class="t hidden">', this.name, '</div>',
                                '<div class="pice hidden" th:inline="text">',
                                '<span>￥', this.salePrice.amount, '</span>',
                                '<font>￥', this.retailPrice.amount, '</font>',
                                '</div>',
                                '<div class="hidden btn">',
                                '<a href="#" class="addToCartBtn">',
                                '<img src="/images/in_48', this.quantityAvailable == 0||!unlock ? '' : '_h', '.png" height="25" data-productid="', this.id, '" data-quantityAvailable="', this.quantityAvailable, '" />',
                                '</a>',
                                '</div>',
                                '</div>'
                            ].join(""));
                            if (((offset - 1) * limit + index == 1) && showAdd == "true") {
                                listHtml.push('<div class="card-5"><img src="/images/new/index/index2.jpg" width="100%"/></div>');
                            }
                            //广告位加入位置
                            //if (((offset - 1) * limit + index == 3) && showAdd == "true") {
                                //listHtml.push('<div class="card-5"><img src="/images/udj_03.jpg" width="100%"/></div>');
                            //}
                        });
                        product_list_panel.find(".product-list").append(listHtml.join(""));
                        $(window).resize();
                        loading = false;
                        if (response.products.product.length < limit) {
                            loadAll = true;
                            product_list_panel.find(".load-more").html("已加载全部");
                        } else {
                            product_list_panel.find(".load-more").html("正在加载更多...");
                            currentOffset++;
                        }
                    },
                    error: function () {
                        loading = false;
                        loadAll = true;
                        product_list_panel.find(".load-more").html("加载商品列表出错");
                    }
                });
            }
        });
        //]]>
    </script>
</div>