<div th:fragment="footer" th:remove="tag" th:inline="text">
    <div th:replace="/fivecard/partials/share::shareFiveCard"></div>
    <footer th:attr="data-item-count=${cart.itemCount},data-unlock=${isUnlocked}">
        <div class="container">
            <a th:if="${showHomeIcon?:true}" th:href="@{/}" title="首页" class="tab1"></a>
            <div th:remove="tag" th:if="${(showHomeIcon==null or showHomeIcon==true) and (showCartIcon==null or showCartIcon==true)}">
                <a th:if="${showCouponIcon?:true}" class="tab2" th:href="@{/manage/couponAndFiveCard}" title="我的卡券"></a>
                <a th:if="${showQrScanIcon?:true}" class="tab3">
                    <span th:id="qrscan"></span>
                </a>
            </div>
            <div th:remove="tag" th:if="${(showHomeIcon!=null and showHomeIcon==false) and (showCartIcon!=null and showCartIcon==false)}">
                <a th:if="${showQrScanIcon?:true}" class="scan">
                    <span th:id="qrscan"></span>
                </a>
                <a th:if="${showCouponIcon?:true}" class="coupon" th:href="@{/manage/couponAndFiveCard}" title="我的卡券"></a>
            </div>
            <a th:if="${showCartIcon?:true}" th:href="@{/cart}" th:id="myCart" title="我的购物车" class="tab4"><span
                    th:style="'display:'+${cart.itemCount==0?'none':'block'}" class="num"
                    th:text="${cart.itemCount}">0</span></a>
            <a th:if="${showOrderIcon?:true}" th:href="@{/account/orders}" title="我的订单" class="tab5"></a>
        </div>
    </footer>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script th:src="@{/js/common.js}"></script>
    <script type="text/javascript" th:inline="text">
        //<![CDATA[
        $(function () {
            wx.ready(function () {
                //微信扫一扫功能
                $("body").on("click", "#qrscan", function () {
                    wx.scanQRCode({
                        needResult: 1,
                        desc: 'scanQRCode desc',
                        success: function (res) {
                            qrScanCallback(res);
                        }
                    });
                });

            });
        });
        $(function () {
            $("#getFiveCard").click(function () {
                location.href = "[[@{/fiveCard/issue}]]";
            });
        });
        function qrScanCallback(res) {
            //mock data
//            res = {"resultStr": "CODE_128,1234567891245", "errMsg": "scanQRCode:ok"};
            //检测是否扫码成功
            if (res.errMsg != "scanQRCode:ok") {
                alert(res.errMsg);
                return;
            }
            //提取二维码
            var code = res.resultStr.split(",")[1];
            console.log("the qr code==>" + code);
            exhangeQRCode(code);
            //兑换二维码
            function exhangeQRCode(code) {
                $.get("[[@{/qr/exchange/}]]" + code)
                        .done(function (data) {
                            console.log(data);
                            if (data.code === 1000) {
                                var token = data.others.issueCouponToken;
                                issueCoupon(token);
                            } else {
                                alert(data.message);
                            }
                        })
                        .fail(function (data) {
                            console.log(data);
                            alert(data.responseText);
                        });
            }

            //发放优惠券
            function issueCoupon(token) {
                var url = '[[@{/coupon/issue/offline}]]' + '?token=' + token;
                $.get(url).done(function (res) {
                    if (res.code == 1000) {
                        dialogUtil.couponWindow.show();
                    } else {
                        alert("优惠券已派完");
                    }
                });
            }
        }
        //]]>
    </script>
</div>